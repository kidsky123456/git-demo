ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Jenkins Pipeline è„šæœ¬ï¼Œç”¨äºæ‰§è¡Œ Cucumber æµ‹è¯•å¹¶å‘å¸ƒ HTML æŠ¥å‘Šï¼ŒåŒæ—¶è§£å†³å½’æ¡£è·¯å¾„åŠ¨æ€å˜åŒ–çš„é—®é¢˜ï¼š

```groovy
pipeline {
    agent any
    
    tools {
        // æ ¹æ®å®é™…å·¥å…·é…ç½®ï¼ˆå¯é€‰ï¼‰
        maven 'Maven_3.8.6'
        jdk 'JDK_17'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Install Dependencies') {
            steps {
                sh 'npm install'
                // æˆ–ä½¿ç”¨ Maven: sh 'mvn clean install'
            }
        }
        
        stage('Run Cucumber Tests') {
            steps {
                // è¿è¡Œæµ‹è¯•å¹¶ç”ŸæˆæŠ¥å‘Š
                script {
                    // ä½¿ç”¨æ—¶é—´æˆ³åˆ›å»ºå”¯ä¸€æŠ¥å‘Šç›®å½•
                    def timestamp = sh(script: 'date +%Y%m%d_%H%M%S', returnStdout: true).trim()
                    env.REPORT_DIR = "cucumber-reports/${timestamp}"
                    
                    // è¿è¡Œæµ‹è¯•å¹¶æŒ‡å®šæŠ¥å‘Šè·¯å¾„
                    sh "mkdir -p ${env.REPORT_DIR}"
                    sh "npx cucumber-js --format json:${env.REPORT_DIR}/cucumber-report.json --format html:${env.REPORT_DIR}/index.html"
                    
                    // æˆ–ä½¿ç”¨ Maven:
                    // sh "mvn test -Dcucumber.plugin='html:${env.REPORT_DIR}/index.html'"
                }
            }
        }
        
        stage('Publish HTML Report') {
            steps {
                script {
                    // éªŒè¯æŠ¥å‘Šæ–‡ä»¶æ˜¯å¦å­˜åœ¨
                    def reportPath = "${env.WORKSPACE}/${env.REPORT_DIR}/index.html"
                    if (!fileExists(reportPath)) {
                        error "âŒ æŠ¥å‘Šæ–‡ä»¶ä¸å­˜åœ¨: ${reportPath}"
                    }
                    
                    // å‘å¸ƒ HTML æŠ¥å‘Š
                    publishHTML(
                        target: [
                            allowMissing: false,
                            alwaysLinkToLastBuild: true,
                            keepAll: true,
                            reportDir: env.REPORT_DIR,
                            reportFiles: 'index.html',
                            reportName: 'Cucumber Test Report'
                        ]
                    )
                    
                    // å­˜å‚¨æŠ¥å‘Šè·¯å¾„ä¾›å½’æ¡£ä½¿ç”¨
                    env.ARCHIVE_PATH = env.REPORT_DIR
                }
            }
        }
        
        stage('Archive Results') {
            steps {
                script {
                    // è·å–åŠ¨æ€ç”Ÿæˆçš„æŠ¥å‘Šè·¯å¾„
                    def archiveDir = env.ARCHIVE_PATH ?: 'cucumber-reports'
                    
                    echo "ğŸ“¦ å½’æ¡£è·¯å¾„: ${archiveDir}"
                    
                    // å½’æ¡£åŸå§‹æŠ¥å‘Šæ–‡ä»¶
                    archiveArtifacts artifacts: "${archiveDir}/**/*", fingerprint: true
                    
                    // å½’æ¡£ JSON æŠ¥å‘Šï¼ˆç”¨äºå…¶ä»–åˆ†æï¼‰
                    archiveArtifacts artifacts: "${archiveDir}/*.json", fingerprint: true
                }
            }
        }
    }
    
    post {
        always {
            // æ¸…ç†å·¥ä½œç©ºé—´ï¼ˆå¯é€‰ï¼‰
            cleanWs()
        }
        success {
            // å‘é€æˆåŠŸé€šçŸ¥
            slackSend color: 'good', message: "Cucumber æµ‹è¯•é€šè¿‡: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
        }
        failure {
            // å‘é€å¤±è´¥é€šçŸ¥
            slackSend color: 'danger', message: "Cucumber æµ‹è¯•å¤±è´¥: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
        }
    }
}
```

### å…³é”®è§£å†³æ–¹æ¡ˆè¯´æ˜ï¼š

1. **åŠ¨æ€æŠ¥å‘Šè·¯å¾„å¤„ç†**ï¼š
   ```groovy
   // åˆ›å»ºå”¯ä¸€æ—¶é—´æˆ³ç›®å½•
   def timestamp = sh(script: 'date +%Y%m%d_%H%M%S', returnStdout: true).trim()
   env.REPORT_DIR = "cucumber-reports/${timestamp}"
   
   // è¿è¡Œæµ‹è¯•æ—¶æŒ‡å®šè·¯å¾„
   sh "npx cucumber-js --format html:${env.REPORT_DIR}/index.html"
   ```

2. **è·¨é˜¶æ®µå…±äº«è·¯å¾„**ï¼š
   ```groovy
   // åœ¨æµ‹è¯•é˜¶æ®µå­˜å‚¨è·¯å¾„åˆ°ç¯å¢ƒå˜é‡
   env.ARCHIVE_PATH = env.REPORT_DIR
   
   // åœ¨å½’æ¡£é˜¶æ®µè·å–è·¯å¾„
   def archiveDir = env.ARCHIVE_PATH ?: 'cucumber-reports'
   ```

3. **è·¯å¾„éªŒè¯**ï¼š
   ```groovy
   // æ£€æŸ¥æŠ¥å‘Šæ˜¯å¦å­˜åœ¨
   def reportPath = "${env.WORKSPACE}/${env.REPORT_DIR}/index.html"
   if (!fileExists(reportPath)) {
       error "âŒ æŠ¥å‘Šæ–‡ä»¶ä¸å­˜åœ¨: ${reportPath}"
   }
   ```

4. **Cucumber æŠ¥å‘Šé…ç½®æŠ€å·§**ï¼š
   - ç¡®ä¿å®‰è£…äº†æ­£ç¡®çš„æŠ¥å‘Šç”Ÿæˆå™¨ï¼š
     ```bash
     npm install @cucumber/html-formatter --save-dev
     ```
   - æˆ–åœ¨ Maven ä¸­é…ç½®ï¼š
     ```xml
     <dependency>
         <groupId>io.cucumber</groupId>
         <artifactId>cucumber-java</artifactId>
         <version>7.15.0</version>
     </dependency>
     <dependency>
         <groupId>io.cucumber</groupId>
         <artifactId>cucumber-junit-platform-engine</artifactId>
         <version>7.15.0</version>
     </dependency>
     ```

### å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆï¼š

**é—®é¢˜1ï¼šæŠ¥å‘Šé“¾æ¥æ˜¾ç¤ºä½†å†…å®¹ç©ºç™½**
```groovy
// åœ¨ pipeline å¼€å¤´æ·»åŠ  CSP ç¦ç”¨
properties([
    systemProperties([
        'hudson.model.DirectoryBrowserSupport.CSP': 'sandbox allow-scripts; default-src \'none\'; img-src \'self\'; style-src \'self\' \'unsafe-inline\'; script-src \'self\' \'unsafe-inline\';'
    ])
])
```

**é—®é¢˜2ï¼šè·¯å¾„åŒ…å«ç©ºæ ¼æˆ–ç‰¹æ®Šå­—ç¬¦**
```groovy
// ä½¿ç”¨å•å¼•å·åŒ…è£¹è·¯å¾„
sh "mkdir -p '${env.REPORT_DIR}'"
publishHTML(reportDir: "'${env.REPORT_DIR}'")
```

**é—®é¢˜3ï¼šå½’æ¡£æ—¶æ‰¾ä¸åˆ°æ–‡ä»¶**
```groovy
stage('Verify Path') {
    steps {
        script {
            sh """
                echo "å½“å‰å·¥ä½œç›®å½•: \$(pwd)"
                echo "æŠ¥å‘Šè·¯å¾„: ${env.ARCHIVE_PATH}"
                ls -laR '${env.ARCHIVE_PATH}'
            """
        }
    }
}
```

### ä¼˜åŒ–å»ºè®®ï¼š

1. **ä½¿ç”¨ Cucumber Jenkins æ’ä»¶**ï¼š
   ```groovy
   stage('Publish Cucumber Report') {
       steps {
           cucumber buildStatus: "UNSTABLE",
                   fileIncludePattern: "**/*.json",
                   jsonReportDirectory: env.REPORT_DIR
       }
   }
   ```
   éœ€è¦å®‰è£… [Cucumber Reports](https://plugins.jenkins.io/cucumber-reports/) æ’ä»¶

2. **å¹¶è¡Œæµ‹è¯•æ‰§è¡Œ**ï¼š
   ```groovy
   stage('Parallel Tests') {
       parallel {
           stage('Chrome') {
               steps {
                   sh "TARGET_BROWSER=chrome npx cucumber-js"
               }
           }
           stage('Firefox') {
               steps {
                   sh "TARGET_BROWSER=firefox npx cucumber-js"
               }
           }
       }
   }
   ```

3. **å†å²è¶‹åŠ¿å›¾**ï¼š
   ```groovy
   stage('Record Trends') {
       steps {
           cucumber buildStatus: "UNSTABLE",
                   fileIncludePattern: "**/*.json",
                   jsonReportDirectory: env.REPORT_DIR,
                   trendsLimit: 10 // æ˜¾ç¤ºæœ€è¿‘10æ¬¡æ„å»ºçš„è¶‹åŠ¿
       }
   }
   ```

å®Œæˆé…ç½®åï¼Œæµ‹è¯•æŠ¥å‘Šä¼šå‡ºç°åœ¨ï¼š
1. Jenkins æ„å»ºé¡µé¢å·¦ä¾§çš„ **Cucumber Test Report** é“¾æ¥
2. æ„å»ºæ‘˜è¦ä¸­çš„ **Cucumber Reports** éƒ¨åˆ†
3. å½’æ¡£æ–‡ä»¶å¯åœ¨æ„å»ºé¡µé¢çš„ **Artifacts** åŒºåŸŸä¸‹è½½

![Cucumber Report in Jenkins](https://www.jenkins.io/doc/book/resources/pipeline/cucumber-report.png)
