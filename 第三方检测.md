# æ–¹æ¡ˆ1
åœ¨Spring Boot 3åº”ç”¨ä¸­ï¼Œç¬¬ä¸‰æ–¹æµ‹è¯•æŠ¥å‘ŠæŒ‡å‡ºçš„å“åº”å¤´é—®é¢˜ï¼Œé€šå¸¸æ˜¯å› ä¸º**å¤šä¸ªé…ç½®æºï¼ˆä¾‹å¦‚Spring Securityã€åº”ç”¨ç¨‹åºè‡ªèº«æˆ–åå‘ä»£ç†ï¼‰åŒæ—¶è®¾ç½®äº†ç›¸åŒçš„HTTPå“åº”å¤´**ï¼Œå¯¼è‡´é‡å¤æˆ–å†²çªã€‚ä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„è¡¨æ ¼æ¥å¿«é€Ÿäº†è§£é—®é¢˜å’Œè§£å†³æ–¹æ³•ï¼š

| é—®é¢˜æè¿°                                     | ä¸»è¦åŸå›                                                                  | è§£å†³æ€è·¯                                                                 |
| :------------------------------------------- | :----------------------------------------------------------------------- | :----------------------------------------------------------------------- |
| â— **Duplicate X-Frame Headers in API Response** | å¤šä¸ªé…ç½®æºï¼ˆå¦‚Spring Securityã€åº”ç”¨ç¨‹åºä»£ç æˆ–åå‘ä»£ç†ï¼‰éƒ½æ·»åŠ äº†`X-Frame-Options`å¤´ã€‚ | **ç»Ÿä¸€é…ç½®å…¥å£**ï¼Œæ£€æŸ¥å¹¶ç§»é™¤é‡å¤é…ç½®ï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ªåœ°æ–¹è®¾ç½®æ­¤å¤´ã€‚                  |
| â— **MisConfigured X-XSS-Protection Header in API Response** | `X-XSS-Protection`å¤´çš„å€¼ä¸ç¬¦åˆå®‰å…¨è§„èŒƒï¼ˆå¦‚æœªè®¾ç½®ä¸º`1; mode=block`ï¼‰ï¼Œæˆ–è€…å…¶é»˜è®¤è¡Œä¸ºåœ¨ç°ä»£æµè§ˆå™¨ä¸­å·²ä¸æ¨èä½¿ç”¨ã€‚ | æ ¹æ®å®‰å…¨è§„èŒƒæ­£ç¡®é…ç½®è¯¥å¤´ï¼Œæˆ–éµå¾ªç°ä»£å®‰å…¨å®è·µï¼Œè€ƒè™‘ä½¿ç”¨**Content Security Policy (CSP)** æ›¿ä»£ã€‚ |

ä¸‹é¢æˆ‘ä»¬å…·ä½“çœ‹çœ‹å¦‚ä½•è§£å†³ã€‚

### ğŸ› ï¸ è§£å†³å“åº”å¤´é—®é¢˜

#### è§£å†³ Duplicate X-Frame Headers é—®é¢˜

è¿™ä¸ªé—®é¢˜æºäºå¤šå¤„è®¾ç½®äº†`X-Frame-Options`å“åº”å¤´ã€‚ä½ éœ€è¦ç¡®ä¿åªæœ‰ä¸€ä¸ªåœ°æ–¹åœ¨ç®¡ç†è¿™ä¸ªå¤´ã€‚

1.  **æ£€æŸ¥å¹¶ç»Ÿä¸€åœ¨Spring Securityä¸­é…ç½®**
    æ¨èåœ¨Spring Securityé…ç½®ä¸­é›†ä¸­ç®¡ç†å®‰å…¨å¤´ã€‚ä½ å¯ä»¥æ˜ç¡®å¯ç”¨æˆ–ç¦ç”¨ç‰¹å®šçš„å¤´ï¼Œä»¥é¿å…ä¸å…¶ä»–é…ç½®å†²çªã€‚
    ```java
    import org.springframework.context.annotation.Bean;
    import org.springframework.context.annotation.Configuration;
    import org.springframework.security.config.annotation.web.builders.HttpSecurity;
    import org.springframework.security.web.SecurityFilterChain;
    import static org.springframework.security.config.Customizer.withDefaults;
    
    @Configuration
    public class SecurityConfig {
    
        @Bean
        public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
            http
                // ... å…¶ä»–æˆæƒé…ç½® ...
                .headers(headers -> headers
                    // æ˜ç¡®é…ç½® frameOptions ä¸º SAMEORIGIN
                    .frameOptions(frameOptions -> frameOptions.sameOrigin())
                    // å¦‚æœä½ åœ¨å…¶ä»–åœ°æ–¹ï¼ˆå¦‚Nginxï¼‰é…ç½®äº†X-Frame-Optionsï¼Œå¯ä»¥åœ¨è¿™é‡Œç¦ç”¨Spring Securityçš„è®¾ç½®
                    // .frameOptions(frameOptions -> frameOptions.disable())
                    // ç¡®ä¿X-XSS-Protectionçš„é…ç½®ä¹Ÿåœ¨è¿™é‡Œç»Ÿä¸€ç®¡ç†ï¼Œè¯¦è§ä¸‹ä¸€éƒ¨åˆ†
                );
            return http.build();
        }
    }
    ```
    **å…³é”®ç‚¹**ï¼š
    *   ä½¿ç”¨ `.frameOptions(frameOptions -> frameOptions.sameOrigin())` ä¼šè®¾ç½® `X-Frame-Options: SAMEORIGIN`ã€‚
    *   å¦‚æœä½ åœ¨**Nginxç­‰åå‘ä»£ç†æˆ–WebæœåŠ¡å™¨**ï¼ˆå¦‚ä¸‹é¢çš„Nginxé…ç½®ç¤ºä¾‹ï¼‰ä¸­ä¹Ÿé…ç½®äº†`X-Frame-Options`ï¼ŒåŠ¡å¿…åœ¨Spring Securityä¸­é€šè¿‡ `.frameOptions(frameOptions -> frameOptions.disable())` **ç¦ç”¨**Spring Securityçš„è®¾ç½®ï¼Œä»¥é˜²é‡å¤ã€‚

2.  **æ£€æŸ¥WebæœåŠ¡å™¨æˆ–åå‘ä»£ç†é…ç½®**
    å¦‚æœä½ åœ¨ä½¿ç”¨Nginxã€Apacheç­‰ï¼Œè¯·æ£€æŸ¥å…¶é…ç½®æ–‡ä»¶ä¸­æ˜¯å¦ä¹Ÿå­˜åœ¨`X-Frame-Options`å¤´çš„è®¾ç½®ã€‚ä¾‹å¦‚ï¼Œåœ¨Nginxä¸­ï¼š
    ```nginx
    # æ£€æŸ¥Nginxé…ç½®ä¸­æ˜¯å¦æœ‰ç±»ä¼¼çš„add_headeræŒ‡ä»¤
    add_header X-Frame-Options SAMEORIGIN;
    ```
    **ç¡®ä¿åº”ç”¨ç¨‹åºå’Œåå‘ä»£ç†ä¸­åªæœ‰ä¸€å¤„è®¾ç½®äº†æ­¤å¤´ã€‚**

3.  **æ£€æŸ¥åº”ç”¨ä»£ç ä¸­çš„æ‰‹åŠ¨è®¾ç½®**
    é¿å…åœ¨Controlleræˆ–Filterä¸­æ‰‹åŠ¨è®¾ç½®`X-Frame-Options`å¤´ï¼Œä¾‹å¦‚ï¼š
    ```java
    // é¿å…è¿™æ ·æ‰‹åŠ¨è®¾ç½®ï¼Œé™¤éä½ ç¡®è®¤æ²¡æœ‰å…¶ä»–é…ç½®æº
    @GetMapping("/some-api")
    public ResponseEntity<String> someEndpoint() {
        return ResponseEntity.ok()
                .header("X-Frame-Options", "SAMEORIGIN") // å¯èƒ½å¯¼è‡´é‡å¤
                .body("Response");
    }
    ```

#### è§£å†³ MisConfigured X-XSS-Protection Header é—®é¢˜

å…³äº`X-XSS-Protection`å¤´ï¼Œéœ€è¦æ³¨æ„ï¼š**ç°ä»£æµè§ˆå™¨å·²å¼ƒç”¨æ­¤å¤´**ï¼Œä¸”OWASPç­‰å®‰å…¨ç»„ç»‡ä¹Ÿ**å»ºè®®æ˜ç¡®å…³é—­å®ƒ**ï¼Œå› ä¸ºå®ƒæœ¬èº«å¯èƒ½å¼•å…¥æ–°çš„å®‰å…¨æ¼æ´ã€‚æ›´æ¨èä½¿ç”¨**Content Security Policy (CSP)** æ¥é˜²å¾¡XSSã€‚ä¸è¿‡ï¼Œæ—¢ç„¶æµ‹è¯•æŠ¥å‘Šè¦æ±‚ï¼Œæˆ‘ä»¬ä»éœ€æ­£ç¡®é…ç½®ã€‚

1.  **åœ¨Spring Securityä¸­æ­£ç¡®é…ç½®**
    åœ¨Spring Securityé…ç½®ä¸­ï¼Œä½ å¯ä»¥è¿™æ ·è®¾ç½®`X-XSS-Protection`å¤´ï¼š
    ```java
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // ... å…¶ä»–é…ç½® ...
            .headers(headers -> headers
                .xssProtection(xss -> xss
                    .headerValue(XXssProtectionHeaderWriter.HeaderValue.ENABLED_MODE_BLOCK)
                )
                // è€ƒè™‘åŒæ—¶å¯ç”¨CSPä½œä¸ºæ›´ç°ä»£çš„é˜²æŠ¤æ‰‹æ®µ
                // .contentSecurityPolicy(csp -> csp.policyDirectives("default-src 'self'"))
            );
        return http.build();
    }
    ```
    **è¯´æ˜**ï¼š
    *   `HeaderValue.ENABLED_MODE_BLOCK` ä¼šè®¾ç½®å¤´ä¸º `1; mode=block`ï¼ŒæŒ‡ç¤ºæµè§ˆå™¨åœ¨æ£€æµ‹åˆ°XSSæ”»å‡»æ—¶é˜»æ­¢é¡µé¢åŠ è½½ã€‚

2.  **å…³äºSpring Securityçš„é»˜è®¤è¡Œä¸º**
    éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**Spring Securityé»˜è®¤æƒ…å†µä¸‹å¯èƒ½ä¸ä¼šå¯ç”¨`X-XSS-Protection`å¤´ï¼Œæˆ–è€…å°†å…¶å€¼è®¾ç½®ä¸º`0`ï¼ˆå³ç¦ç”¨ï¼‰**ï¼Œå› ä¸ºå®ƒè¢«ç°ä»£æµè§ˆå™¨å¼ƒç”¨ä¸”å¯èƒ½å­˜åœ¨å‰¯ä½œç”¨ã€‚å› æ­¤ï¼Œä½ éœ€è¦å¦‚ä¸Šæ‰€è¿°æ˜ç¡®é…ç½®ã€‚

3.  **åœ¨WebæœåŠ¡å™¨ï¼ˆå¦‚Nginxï¼‰ä¸­é…ç½®**
    åŒæ ·ï¼Œå¦‚æœä½ åœ¨Nginxç­‰åå‘ä»£ç†ä¸­é…ç½®ï¼Œå¯ä»¥æ·»åŠ ï¼š
    ```nginx
    add_header X-XSS-Protection "1; mode=block";
    ```
    å¹¶ç¡®ä¿åªåœ¨æŸä¸€å¤„é…ç½®ã€‚

### ğŸ’¡ æœ€ä½³å®è·µä¸é¢„é˜²æªæ–½

1.  **é›†ä¸­ç®¡ç†å®‰å…¨å¤´**ï¼šå¼ºçƒˆå»ºè®®åœ¨**Spring Securityçš„é…ç½®ç±»ä¸­ç»Ÿä¸€ç®¡ç†**æ‰€æœ‰å®‰å…¨ç›¸å…³çš„HTTPå“åº”å¤´ï¼Œä¾¿äºç»´æŠ¤å’Œé¿å…å†²çªã€‚
2.  **ä¼˜å…ˆé‡‡ç”¨ç°ä»£å®‰å…¨æ ‡å‡†**ï¼š
    *   å¯¹äºXSSé˜²æŠ¤ï¼Œ**Content Security Policy (CSP)** æ˜¯æ›´å¼ºå¤§å’Œæ¨èçš„æ–¹å¼ã€‚ä½ å¯ä»¥åœ¨Spring Securityä¸­å¯ç”¨CSPï¼š
        ```java
        .headers(headers -> headers
            .contentSecurityPolicy(csp -> csp
                .policyDirectives("default-src 'self'; script-src 'self' example.com; object-src 'none';"))
        // å…¶ä»–é…ç½®...
        )
        ```
    *   **æ³¨æ„**ï¼šCSPçš„é…ç½®éœ€è¦æ ¹æ®ä½ çš„å…·ä½“èµ„æºåŠ è½½éœ€æ±‚è¿›è¡Œè°ƒæ•´ï¼Œé”™è¯¯çš„é…ç½®å¯èƒ½å¯¼è‡´ç½‘ç«™åŠŸèƒ½å¼‚å¸¸ã€‚
3.  **å½»åº•æµ‹è¯•**ï¼šå®Œæˆé…ç½®ä¿®æ”¹åï¼ŒåŠ¡å¿…ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆæŸ¥çœ‹"Network"é€‰é¡¹å¡ï¼‰æˆ–ä¸“é—¨çš„HTTPå¤´æ£€æŸ¥å·¥å…·éªŒè¯APIå“åº”å¤´ï¼Œç¡®ä¿é‡å¤é—®é¢˜å·²è§£å†³ï¼Œä¸”æ‰€æœ‰å¤´çš„å€¼ç¬¦åˆé¢„æœŸã€‚

### ğŸ’ æ€»ç»“

æ€»çš„æ¥è¯´ï¼Œè§£å†³è¿™ç±»å“åº”å¤´é—®é¢˜ï¼Œå…³é”®åœ¨äº**æ’æŸ¥æ‰€æœ‰å¯èƒ½çš„é…ç½®æºï¼ˆåº”ç”¨ä»£ç ã€Spring Securityã€åå‘ä»£ç†ï¼‰ï¼Œå¹¶ç¡®ä¿åªæœ‰ä¸€ä¸ªæºå¤´åœ¨èµ·ä½œç”¨**ã€‚å¯¹äºSpring Bootåº”ç”¨ï¼Œåœ¨Spring Securityé…ç½®ä¸­ç»Ÿä¸€ç®¡ç†é€šå¸¸æ˜¯æ¸…æ™°å¯é çš„åšæ³•ã€‚

å¸Œæœ›è¿™äº›ä¿¡æ¯èƒ½å¸®åŠ©ä½ è§£å†³é—®é¢˜ã€‚å¦‚æœä½ çš„é¡¹ç›®ä¸­æœ‰ä½¿ç”¨åå‘ä»£ç†ï¼ˆæ¯”å¦‚Nginxï¼‰ï¼Œå¹¶ä¸”é…ç½®è°ƒæ•´æ¶‰åŠå¤šæ–¹é¢ï¼Œå¯èƒ½éœ€è¦ååŒå¤„ç†ã€‚




åœ¨ Spring Boot 3 ä¸­ï¼Œé’ˆå¯¹ç‰¹å®š API ç«¯ç‚¹ï¼ˆå¦‚ `/transaticon/propose`ï¼‰é…ç½®å®‰å…¨å“åº”å¤´ï¼Œæ¨èä½¿ç”¨ `HttpSecurity` çš„ `requestMatchers` æ–¹æ³•ã€‚è¿™å…è®¸ä½ ä¸ºç‰¹å®šè·¯å¾„å®šä¹‰å•ç‹¬çš„å®‰å…¨è§„åˆ™ã€‚

ä»¥ä¸‹æ˜¯å…·ä½“çš„é…ç½®æ–¹æ³•ï¼Œä½ å¯ä»¥å‚è€ƒè¿™ä¸ªç¤ºä¾‹æ¥è°ƒæ•´ä½ çš„å®‰å…¨é…ç½®ï¼š

### å®‰å…¨é…ç½®ç¤ºä¾‹

```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.header.HeaderWriterFilter;

@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // å…¨å±€å®‰å…¨é…ç½®
            .authorizeHttpRequests(authz -> authz
                .anyRequest().permitAll() // æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´å…¨å±€æƒé™
            )
            .headers(headers -> headers
                // å…¨å±€å®‰å…¨å¤´é…ç½®ï¼ˆé€‚ç”¨äºå¤§å¤šæ•°ç«¯ç‚¹ï¼‰
                .frameOptions(frameOptions -> frameOptions.deny())
                .xssProtection(xss -> xss.headerValue(XXssProtectionHeaderWriter.HeaderValue.DISABLED))
                .contentSecurityPolicy(csp -> csp.policyDirectives("default-src 'self'"))
            )
            // ä¸ºç‰¹å®šAPIæ·»åŠ è‡ªå®šä¹‰å®‰å…¨å¤´è¿‡æ»¤å™¨
            .addFilterAfter(customHeadersFilter(), HeaderWriterFilter.class);

        return http.build();
    }

    @Bean
    public CustomHeadersFilter customHeadersFilter() {
        return new CustomHeadersFilter("/transaticon/propose");
    }
}
```

**å…³é”®ç‚¹è¯´æ˜**ï¼š
- ä½¿ç”¨ `requestMatchers("/transaticon/propose")` æ¥åŒ¹é…ç‰¹å®šè·¯å¾„ã€‚
- åœ¨åŒ¹é…åˆ°çš„è·¯å¾„ä¸Šï¼Œé€šè¿‡ `headers` é…ç½®è‡ªå®šä¹‰å®‰å…¨å¤´ã€‚
- å…¶ä»–è·¯å¾„çš„è¯·æ±‚å°†ç”±åç»­çš„ `SecurityFilterChain` æˆ–å…¨å±€é…ç½®å¤„ç†ã€‚

### è‡ªå®šä¹‰è¿‡æ»¤å™¨æ–¹å¼ï¼ˆå¯é€‰ï¼‰

å¦‚æœä¸Šè¿°æ–¹å¼ä¸ç”Ÿæ•ˆï¼Œæˆ–è€…ä½ éœ€è¦æ›´ç²¾ç»†çš„æ§åˆ¶ï¼Œå¯ä»¥è€ƒè™‘å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„ `OncePerRequestFilter`ï¼š

```java
import org.springframework.web.filter.OncePerRequestFilter;
import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

public class CustomHeadersFilter extends OncePerRequestFilter {
    
    private final String targetPath;

    public CustomHeadersFilter(String targetPath) {
        this.targetPath = targetPath;
    }

    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                  HttpServletResponse response, 
                                  FilterChain filterChain) 
            throws ServletException, IOException {
        
        // æ£€æŸ¥è¯·æ±‚è·¯å¾„æ˜¯å¦åŒ¹é…ç›®æ ‡API
        if (request.getRequestURI().equals(targetPath)) {
            // ç§»é™¤å¯èƒ½é‡å¤çš„å¤´éƒ¨
            response.setHeader("X-Frame-Options", "SAMEORIGIN");
            response.setHeader("X-XSS-Protection", "1; mode=block");
        }
        
        filterChain.doFilter(request, response);
    }
}
```

### é’ˆå¯¹ä½ æåˆ°çš„é—®é¢˜

1.  **Duplicate X-Frame Headers**ï¼š
    - ç¡®ä¿**åªæœ‰ä¸€ä¸ªåœ°æ–¹**ï¼ˆè¦ä¹ˆåœ¨ Security é…ç½®ä¸­ï¼Œè¦ä¹ˆåœ¨è‡ªå®šä¹‰è¿‡æ»¤å™¨ä¸­ï¼‰è®¾ç½®äº† `X-Frame-Options` å¤´ã€‚
    - æ£€æŸ¥æ˜¯å¦åœ¨ **Nginx/Apache** ç­‰åå‘ä»£ç†ä¸­ä¹Ÿè®¾ç½®äº†æ­¤å¤´ã€‚å¦‚æœå·²è®¾ç½®ï¼Œå»ºè®®åœ¨ Spring åº”ç”¨ä¸­**ç¦ç”¨**æ­¤å¤´é…ç½®ï¼Œç»Ÿä¸€åœ¨ä»£ç†å±‚ç®¡ç†ã€‚

2.  **MisConfigured X-XSS-Protection Header**ï¼š
    - å»ºè®®æ˜ç¡®è®¾ç½®ä¸º `"1; mode=block"`ï¼Œå¦‚ä¸Šä¾‹æ‰€ç¤ºã€‚
    - è¯·æ³¨æ„ï¼Œç°ä»£æµè§ˆå™¨å·²**å¼ƒç”¨**æ­¤å¤´ï¼Œæ›´æ¨èä½¿ç”¨ **Content Security Policy (CSP)** æ¥é˜²å¾¡ XSS æ”»å‡»ã€‚ä½ å¯ä»¥åœ¨ Security é…ç½®ä¸­å¯ç”¨ CSPï¼š
        ```java
        .headers(headers -> headers
            .contentSecurityPolicy(csp -> csp
                .policyDirectives("default-src 'self'; script-src 'self'"))
        )
        ```

### è¡¥å……å»ºè®®

- **æµ‹è¯•éªŒè¯**ï¼šé…ç½®å®Œæˆåï¼Œä½¿ç”¨ **Postman** æˆ–æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆç½‘ç»œé€‰é¡¹å¡ï¼‰æ£€æŸ¥ `/transaticon/propose` æ¥å£çš„å“åº”å¤´ï¼Œç¡®è®¤é‡å¤é—®é¢˜å·²è§£å†³ä¸”å¤´å€¼æ­£ç¡®ã€‚
- **ç»Ÿä¸€ç®¡ç†**ï¼šå°½å¯èƒ½åœ¨ **Spring Security é…ç½®ä¸­é›†ä¸­ç®¡ç†**å®‰å…¨å¤´ï¼Œé¿å…åœ¨å¤šä¸ªä½ç½®ï¼ˆå¦‚ Controllerã€Filterã€ä»£ç†æœåŠ¡å™¨ï¼‰é‡å¤è®¾ç½®ã€‚

å¸Œæœ›è¿™äº›é…ç½®èƒ½å¸®åŠ©ä½ è§£å†³é—®é¢˜ã€‚å¦‚æœè¿˜æœ‰å…¶ä»–ç–‘é—®ï¼Œæ¬¢è¿ç»§ç»­äº¤æµã€‚

# æœ€ä½³æ–¹æ¡ˆ
# Spring Boot 3 æœ€ä½³æ–¹æ¡ˆï¼šé’ˆå¯¹ç‰¹å®š API çš„å®‰å…¨å¤´é…ç½®

åŸºäºä½ çš„éœ€æ±‚ï¼Œæˆ‘æ¨èä»¥ä¸‹**æœ€ä½³æ–¹æ¡ˆ**ï¼Œå®ƒç»“åˆäº† Spring Security çš„çµæ´»æ€§å’Œä»£ç çš„æ¸…æ™°æ€§ï¼š

## ğŸ¯ æ–¹æ¡ˆä¸€ï¼šåŸºäºè·¯å¾„åŒ¹é…çš„å®‰å…¨é…ç½®ï¼ˆæ¨èï¼‰

```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.util.matcher.AntPathRequestMatcher;

@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authz -> authz
                .anyRequest().permitAll() // æ ¹æ®ä½ çš„å®é™…éœ€æ±‚è°ƒæ•´
            )
            .headers(headers -> headers
                // å…¨å±€é»˜è®¤é…ç½® - æ›´å®‰å…¨çš„å€¼
                .frameOptions(frameOptions -> frameOptions.deny())
                .xssProtection(xss -> xss.disable()) // ç°ä»£æµè§ˆå™¨å·²å¼ƒç”¨ï¼Œæ¨èç¦ç”¨
                .contentSecurityPolicy(csp -> csp.policyDirectives("default-src 'self'"))
            )
            // ä¸ºç‰¹å®šAPIæ·»åŠ è‡ªå®šä¹‰å®‰å…¨é…ç½®
            .with(new SpecificApiConfigurer(), customizer -> {
                customizer
                    .requestMatcher(new AntPathRequestMatcher("/transaticon/propose"))
                    .headers(specificHeaders -> specificHeaders
                        .frameOptions(frameOptions -> frameOptions.sameOrigin())
                        .xssProtection(xss -> xss.headerValue(
                            org.springframework.security.web.header.writers.XXssProtectionHeaderWriter.HeaderValue.ENABLED_MODE_BLOCK
                        ))
                    );
            });

        return http.build();
    }

    // ç‰¹å®šAPIé…ç½®å™¨
    private static class SpecificApiConfigurer implements Customizer<HttpSecurity> {
        @Override
        public void customize(HttpSecurity http) {
            // è¿™ä¸ªé…ç½®ä¼šåœ¨ä¸»é…ç½®åŸºç¡€ä¸Šåº”ç”¨ç‰¹å®šè§„åˆ™
        }
    }
}
```

## ğŸ›¡ï¸ æ–¹æ¡ˆäºŒï¼šè‡ªå®šä¹‰è¿‡æ»¤å™¨ï¼ˆæ›´ç²¾ç¡®æ§åˆ¶ï¼‰

å¦‚æœæ–¹æ¡ˆä¸€ä¸å¤Ÿçµæ´»ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªæ›´ç²¾ç¡®çš„æ–¹æ¡ˆï¼š

```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.header.HeaderWriterFilter;
import org.springframework.web.filter.OncePerRequestFilter;

import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authz -> authz
                .anyRequest().permitAll()
            )
            .headers(headers -> headers
                // å…¨å±€é…ç½® - ä½¿ç”¨å®‰å…¨é»˜è®¤å€¼
                .frameOptions(frameOptions -> frameOptions.deny())
                .xssProtection(xss -> xss.disable()) // æ˜ç¡®ç¦ç”¨ï¼Œé¿å…å†²çª
            )
            // æ·»åŠ è‡ªå®šä¹‰å¤´è¿‡æ»¤å™¨
            .addFilterAfter(apiSpecificHeaderFilter(), HeaderWriterFilter.class);

        return http.build();
    }

    @Bean
    public ApiSpecificHeaderFilter apiSpecificHeaderFilter() {
        return new ApiSpecificHeaderFilter();
    }

    // è‡ªå®šä¹‰è¿‡æ»¤å™¨ç±»
    public static class ApiSpecificHeaderFilter extends OncePerRequestFilter {
        
        @Override
        protected void doFilterInternal(HttpServletRequest request,
                                      HttpServletResponse response,
                                      FilterChain filterChain)
                throws ServletException, IOException {
            
            // åœ¨å¤„ç†è¯·æ±‚å‰è®¾ç½®ç‰¹å®šAPIçš„å¤´
            if (request.getRequestURI().equals("/transaticon/propose")) {
                setupSpecificHeaders(response);
            }
            
            filterChain.doFilter(request, response);
        }
        
        private void setupSpecificHeaders(HttpServletResponse response) {
            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„é‡å¤å¤´
            response.setHeader("X-Frame-Options", "SAMEORIGIN");
            response.setHeader("X-XSS-Protection", "1; mode=block");
            
            // å¯é€‰ï¼šæ·»åŠ CSPä½œä¸ºæ›´å¥½çš„XSSé˜²æŠ¤
            response.setHeader("Content-Security-Policy", "default-src 'self'");
        }
        
        @Override
        protected boolean shouldNotFilterAsyncDispatch() {
            return false;
        }
    }
}
```

## ğŸ”§ è¡¥å……é…ç½®ï¼šæ£€æŸ¥å¹¶ç»Ÿä¸€é…ç½®æº

ä¸ºç¡®ä¿å½»åº•è§£å†³é—®é¢˜ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹ä½ç½®ï¼š

### 1. æ£€æŸ¥ Controller ä¸­çš„æ‰‹åŠ¨è®¾ç½®
```java
@RestController
public class YourController {
    
    @GetMapping("/transaticon/propose")
    public ResponseEntity<String> proposeTransaction() {
        // âŒ é¿å…åœ¨è¿™é‡Œæ‰‹åŠ¨è®¾ç½®å®‰å…¨å¤´
        // return ResponseEntity.ok()
        //     .header("X-Frame-Options", "SAMEORIGIN") // è¿™ä¼šå¯¼è‡´é‡å¤
        //     .body("data");
        
        // âœ… åªè¿”å›æ•°æ®ï¼Œè®©å®‰å…¨é…ç½®å¤„ç†å¤´
        return ResponseEntity.ok("data");
    }
}
```

### 2. æ£€æŸ¥åå‘ä»£ç†é…ç½®ï¼ˆå¦‚ Nginxï¼‰
```nginx
# å¦‚æœåœ¨è¿™é‡Œé…ç½®äº†å®‰å…¨å¤´ï¼Œè¯·åœ¨Springä¸­ç¦ç”¨ç›¸åº”é…ç½®
location /transaticon/propose {
    # ç¡®ä¿åªåœ¨ä¸€å¤„é…ç½®å®‰å…¨å¤´
    # add_header X-Frame-Options SAMEORIGIN; # æ³¨é‡Šæ‰ï¼Œè®©Springå¤„ç†
    proxy_pass http://yourapp;
}
```

## ğŸ“‹ éªŒè¯æ­¥éª¤

é…ç½®å®Œæˆåï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼éªŒè¯ï¼š

```bash
# ä½¿ç”¨ curl æ£€æŸ¥å“åº”å¤´
curl -I http://your-domain/transaticon/propose

# åº”è¯¥çœ‹åˆ°ï¼š
# X-Frame-Options: SAMEORIGIN
# X-XSS-Protection: 1; mode=block
# å¹¶ä¸”æ²¡æœ‰é‡å¤çš„å¤´
```

## ğŸ† æœ€ä½³æ–¹æ¡ˆæ€»ç»“

æˆ‘**æ¨èä½¿ç”¨æ–¹æ¡ˆä¸€**ï¼Œå› ä¸ºï¼š

1. **ç¬¦åˆ Spring Security è®¾è®¡æ¨¡å¼** - ä½¿ç”¨å†…ç½®çš„é…ç½®æœºåˆ¶
2. **ç»´æŠ¤æ€§å¥½** - é…ç½®é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹
3. **æ‰©å±•æ€§å¼º** - æ˜“äºæ·»åŠ æ›´å¤šç‰¹å®šè·¯å¾„çš„é…ç½®
4. **æ€§èƒ½æœ€ä½³** - é¿å…ä¸å¿…è¦çš„è¿‡æ»¤å™¨è°ƒç”¨

å¦‚æœæ–¹æ¡ˆä¸€åœ¨ä½ çš„ Spring Boot 3 ç‰ˆæœ¬ä¸­ä¸å…¼å®¹ï¼Œåˆ™ä½¿ç”¨**æ–¹æ¡ˆäºŒ**ä½œä¸ºå¤‡é€‰ã€‚

ä¸¤ç§æ–¹æ¡ˆéƒ½èƒ½æœ‰æ•ˆè§£å†³ä½ é‡åˆ°çš„ç¬¬ä¸‰æ–¹æµ‹è¯•æŠ¥å‘ŠæŒ‡å‡ºçš„é—®é¢˜ï¼ŒåŒæ—¶ä¿æŒä»£ç çš„æ¸…æ™°å’Œå¯ç»´æŠ¤æ€§ã€‚

      
